#!/bin/bash
# vim: ts=3 sw=3 fdm=indent:
: utility - impl-update,fence,fix
	timens(){
		cat /proc/timer_list  | grep now | cut -d\  -f3
	}
	impl-update(){
		grep '^[ '$'\t'']*[a-z]\+-impl(' $_r/scripts/main |\
			sed 's/^[ \t]*\([a-z]\+\)-impl(.*$/\1(){ fence \&\& \1-impl "$@" ; } /g' > $_r/scripts/impl
	}
	fence(){
		bf=""
		d="$(pwd)" # current source dirname
		b=""
		d="${d##$_r/}"
		b="$d"
		dd="${d%%-first}"
		case "$dd" in
			libc* ) b=glibc ;;
			binutils* ) b=binutils-gdb ;;
			gcc* ) b=gcc ;;
			* ) b="$dd"
		esac

	#	bf=""
	#	if [ -f "$_r/configures/$b" ] ; then
	#		bf="$_r/configures/$b"
	#	fi
	#	[ -z "$bf" ] && echo not a good dir && return 1
		return 0
	}
	fix(){
		case "$1" in
			e* ) f=env ;;
			c* ) f=scripts/configure ;;
			* ) f=scripts/main ;;
		esac
		vi $_r/$f
		impl-update
		( cd $_r ; git add -A ; git commit -a -m $( date +%s) )
		. $_r/env
	}
	newlog(){
		date +%s > $_r/scripts/log/latestlogtime
	}
	log(){
		if [ -n "." ] ; then
			otim="$( timens )"
			dtim=300000000
			sectim=1000000000 # 1 second
			dstim="$(( $dtim / $sectim )).$(( $dtim % $sectim))"
			ctim=0
			local t=""
			local lf="$_r/scripts/log/$( cat $_r/scripts/log/latestlogtime )"
			echo -n "$1..."
			#"${@:2}" |& stdbuf -i0 -o0 sed -zu 's/[ 	]\+\\\n[ 	]\+/ /g' | while read -r l ; do
			"${@:2}" |& while read -t "$dstim" -r l || test $? -gt 128 ; do
				tim="$( timens )"
				if [ -n "$l" ] ; then
					echo "$l" >>$lf
					unset l
				else
					echo -n .
					otim=$tim
					ctim=0
				fi
				if [[ $ctim -gt 256 ]] ; then
					ch="#"
				elif [[ $ctim -gt 128 ]] ; then
					ch="@"
				elif [[ $ctim -gt 64 ]] ; then
					ch="$"
				elif [[ $ctim -gt 32 ]] ; then
					ch="%"
				elif [[ $ctim -gt 16 ]] ; then
					ch="!"
				elif [[ $ctim -gt 8 ]] ; then
					ch="*"
				elif [[ $ctim -gt 4 ]] ; then
					ch="+"
				elif [[ $ctim -gt 2 ]] ; then
					ch="-"
				else
					ch="."
				fi
				echo -ne '\b'"$ch"
				if [ $(( $tim - $otim )) -gt $dtim ] ; then
					echo -n .
					otim=$tim
					ctim=0
				else
					let ctim="$ctim+1"
				fi
			done
			echo
		else
			"${@:2}"
			#"${@:2}" |&  sed -zu 's/[ 	]\+\\\n[ 	]\+/ /g' 
		fi
	}
	logmsg(){
		echo "$@"
		echo "$@" >>$_r/scripts/log/$t
	}
: configuration - ccat,conf,reconf,confhelp
	conf-impl(){
		if declare -fF conf-$d >/dev/null ; then
			$_s/$b/configure $( conf-$d )  || return 1
		else
			echo "No configure found."
			return 1
		fi
	}
	reconf-impl(){
		vi "$bf"
		conf
	}
	confhelpa-impl(){
		$_s/$d/configure --help=recursive |& less
	}
	confhelp-impl(){
		$_s/$d/configure --help |& less
	}
: make - go,inst,kernelh
	go-impl(){
		tgtr=all
#		case "$d" in
#			gcc-first ) tgtr=all-gcc ;;
#			gcc* ) tgtr=all-gcc ;;
#		esac

		make $_m_fl $tgtr "$@"
	}
	inst-impl(){
		instvar="DESTDIR"
		instcmd="install"
		case "$d" in
			glibc* | libc* ) instvar="install_root" ;;
#			gcc* ) instcmd="install-gcc" ;;
		esac
		destd="$_r/dest/$d"
		mkdir "$destd"
		make $_m_fl -C $_r/$d $_m_fl $instvar="$destd" $instcmd "$@" &&
		pesrp $destd	|| return 1

	}
	place-impl(){
		echo "$d	$_r	$_p"
		echo rsync -Pav "$_r/dest/$d/$_p/" "$_p" || return $?
		rsync -Pav "$_r/dest/$d/$_p/" "$_p" || return $?
	}
	kernelh-impl(){
		git -C $_s/linux checkout current_stable	
		make $_m_fl -C $_s/linux INSTALL_HDR_PATH=$_p ARCH=$_a_bl headers_install
	}
: misc - ldcheck,ldfix,redo,buildall
	redo-impl(){ 
		[ -z "$1" ] && return
		if [ -d "$_r/$1" ] ; then
			cd $_r &&
			chmod -R u+rw $_r/$d &&
			rm -r $_r/$1
		fi
		mkdir $_r/$1 &&
		cd $_r/$1 &&
		fence &&
		conf-impl &&
		go-impl &&
		inst-impl || return 1
	}
	alter-impl(){
		redo-impl "$@" &&
		place-impl
	}
	pepint () { # PatchElf Print INTerpreter;
		 [ -n "$1" ] && d="$1" || d="."
		 find "$d" -type f -exec bash -c 'echo -n "{} " ; patchelf --print-interpreter "{}"' \;
	}
	pesint(){ 
		 [ -n "$1" ] && d="$1" || d="."
		 if [ -n "$2" ]; then
			  ld="$2"
		 else
			  if [ -f "$_p/lib/ld-2.26.so" ]; then
					ld="$_p/lib/ld-2.26.so"
			  else
					echo "Cannot fix, no linker found."
					return 1
			  fi
		 fi
		 find "$d" -type f -exec bash -c 'echo -n "{} " ; patchelf --set-interpreter '"$ld"' "{}"' \;
	}
	pesr(){
		 [ -n "$1" ] && d="$1" || d="."
		 [ -n "$2" ] && ld="$2" || ld="$_p/lib"
		 find "$d" -type f -exec bash -c 'patchelf --set-rpath'"$ld"' "{}" >& /dev/null && echo "{} patched."' \;
	}
	pesrp(){ 
		local pesrpd
		[ -n "$1" ] && pesrpd="$1" || pesrpd="."
		if [ -n "$2" ]; then
		ld="$2"
		elif [ -d "$_p/lib" ]; then
			ld="$_p/lib"
		else
			echo "Cannot fix, no libdir found."
			return 1
		fi
		rm -rf "$pesrpd.tmp"
		cp -r "$d" "$pesrpd.tmp"
		TMPDIR=${TMPDIR:-/tmp}
		find "$d" -type f -exec bash -c 'patchelf --set-rpath '"$ld"' "{}" >& '"$TMPDIR/pesrp.tmp"' && echo "{} patched. '"$( cat $TMPDIR/pesrp.tmp | tr '\n' ' ' )"'"' \;
	}
	buildall-impl(){
		if [ -d "$_p" ] ; then
			echo ERROR: something is in the way
			return 1
		fi	
		( 
			export PATH=$_p:$PATH
			mkdir -p $_p/lib &&
			log 'Copying kernel headers' kernelh-impl &&
			xpkg binutils-first gmp-first mpfr-first mpc-first isl-first zlib-first gcc-first || return 1

			# export -n LD_LIBRARY_PATH &&
			# xpkg glibc-first binutils gmp mpfr mpc isl gcc glibc
		) || return 1
	}
	xpkg(){
		[ -n "$1" ] &&
		mkdir -p $_r/$1 &&
		cd $_r/$1 &&
		fence &&
		log "Building $1" alter-impl "$@" &&
		shift &&
		xpkg "$@" || true
	}
	rebuildall(){
		fence && rebuildall-impl "$@"
	}
	rebuildall-impl (){
		 rm -rf $_p
		 buildall "$@"
	}
	lastlog () {
		 less -S "$(find $_r/scripts/log | grep '/[0-9]\+$' | sort -rn | head -1)"
	}
	lastclog () { 
		 lf="$(find $_r/scripts/log | grep '/[0-9]\+$' | sort -rn | head -1)"
		 clf="$(grep -B2 'See .config.log. for more details' $lf | head -1 | sed 's/configure: error: in `//g ; s/'\''://g')/config.log"
		 less -S "$clf"
	}
: eof
